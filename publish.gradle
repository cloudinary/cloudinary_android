apply plugin: 'signing'
apply plugin: "de.marcphilipp.nexus-publish"
apply plugin: "io.codearte.nexus-staging"
apply plugin: 'digital.wup.android-maven-publish'

if (hasProperty("ossrhTokenPassword")) {
    signing {
        sign configurations.archives
    }

    nexusStaging {
        packageGroup = group
        username = project.hasProperty("ossrhToken") ? project.ext["ossrhToken"] : ""
        password = project.hasProperty("ossrhTokenPassword") ? project.ext["ossrhTokenPassword"] : ""
    }

    publishing {
        publications {
            mavenAar(MavenPublication) {
                from components.android

                pom {
                    name = publishArtifactName
                    packaging = 'aar'
                    groupId = publishGroupId
                    artifactId = publishArtifactId
                    description = publishDescription
                    url = githubUrl
                    licenses {
                        license {
                            name = licenseName
                            url = licenseUrl
                        }
                    }

                    developers {
                        developer {
                            id = developerId
                            name = developerName
                            email = developerEmail
                        }
                    }
                    scm {
                        connection = scmConnection
                        developerConnection = scmDeveloperConnection
                        url = scmUrl
                    }
                }
            }
        }

        nexusPublishing {
            repositories {
                sonatype {
                    username = project.hasProperty("ossrhToken") ? project.ext["ossrhToken"] : ""
                    password = project.hasProperty("ossrhTokenPassword") ? project.ext["ossrhTokenPassword"] : ""
                }
            }
        }
    }

    // Configure signing to happen after evaluation
    afterEvaluate {
        signing.sign publishing.publications.mavenAar
    }
}

// Enable sources and javadoc generation for Android libraries
android {
    publishing {
        singleVariant('release') {
            withSourcesJar()
            withJavadocJar()
        }
    }
}

// Ensure signing happens before publishing
tasks.withType(PublishToMavenRepository) {
    dependsOn tasks.withType(Sign)
}

tasks.withType(GenerateModuleMetadata) {
    enabled = false
}